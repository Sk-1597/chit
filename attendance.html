<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance</title>
  <link rel="stylesheet" href="./resources/css/atten.css">
</head>

<body>
 <body class="attendance-page">

  <header class="topbar">
    <div class="user-info">
      <a href="profile.html"><img src="./resources/icons/user.png" class="user-icon" alt="User"> </a>     
    </div>
    <div class="top-icons">
  <a href="history.html">
    <img src="./resources/icons/history.png" alt="Report" class="icon-btn">
  </a>
  <button id="signOutBtn" class="signout-btn">
    <img src="./resources/icons/logout.png" alt="Logout" class="icon-btn">
  </button>
</div>
  </header>

  <main class="content">    
    <div>
        <p class="welcome-text">Welcome,</p>
        <h2 id="userName"></h2>
      </div>

    <section class="card">
      <div class="card-header">
        <h3>Today Attendance</h3>
        <div class="check-bttn">
        <button id="markBtn" class="btn checkin">Check In</button>
        <button id="checkout" class="btn checkout">Check out</button>
        </div>
      </div>
      <div class="card-body blue">
        <p class="branch"><img src="./resources/icons/location.png" alt="" srcset="" ><span id="branchSelect"></span></p>
        <p><img src="./resources/icons/checkin.png" alt="" srcset=""><span id="inTime">29 Sep 2025 : 09 : 00 : 01 AM</span></p>
        <p><img src="./resources/icons/checkout.png" alt="" srcset=""><span id="outTime">29 Sep 2025 : 05 : 00 : 05 PM</span></p>
      </div>
    </section>

    <section class="card brake">
      <div class="card-header">
        <h3>Break Time</h3>
        <div class="check-bttn">
        <button id="brkout" class="btn brkin">Out</button>
        <button id="brkin"  class="btn brkout">In</button>
      </div>
      </div>
      <div class="card-body red">
        <p class="branch"><img src="./resources/icons/location.png" alt="" srcset="" ><span id="branchSelect1"></span></p>
        <p><img src="./resources/icons/checkout.png" alt="" srcset="">29 Sep 2025 : 02 : 5 : 01 AM</p>
        <p><img src="./resources/icons/checkin.png" alt="" srcset="">29 Sep 2025 : 03 : 15 : 05 PM</p>
        <p><img src="./resources/icons/purpose.png" alt="" srcset="">Hospital</p>
      </div>
    </section>
  </main>

  <script type="module">
  import { db } from './firebase.js';
  import { getDoc, doc, addDoc, collection, getDocs, query, where, serverTimestamp } 
    from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  const currentUser = JSON.parse(localStorage.getItem("loggedUser"));
  if (!currentUser) {
    window.location.href = "index.html";
  }

  userName.textContent = currentUser.user;

  const branchRef = doc(db, "branches", currentUser.branchId);
  const branchDoc = await getDoc(branchRef);
  if (branchDoc.exists()) {
    branchSelect.innerHTML = `<option>${branchDoc.data().name}</option>`;
     branchSelect1.innerHTML = `<option>${branchDoc.data().name}</option>`;
  }

  function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) ** 2 +
              Math.cos(lat1 * Math.PI / 180) *
              Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon / 2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  markBtn.onclick = async () => {
    status.innerText = "";

    const bDoc = await getDoc(branchRef);
    if (!bDoc.exists()) return alert("Branch not found");
    const b = bDoc.data();

    navigator.geolocation.getCurrentPosition(async (pos) => {
      const { latitude, longitude } = pos.coords;
      const distance = getDistance(latitude, longitude, b.lat, b.lng);
      const branchRadius = Number(b.radius_m);

      if (isNaN(b.lat) || isNaN(b.lng)) return alert("‚ö†Ô∏è Invalid branch coordinates");
      if (isNaN(branchRadius)) return alert("‚ö†Ô∏è Invalid branch radius");

      if (currentUser.role !== "admin" && distance > branchRadius) {
        alert(`üö´ Outside branch area (${Math.round(distance)}m > ${branchRadius}m)`);
        return;
      }

      const todayStr = new Date().toISOString().slice(0,10);
      const q = query(collection(db, "attendance"),
                      where("userId", "==", currentUser.id),
                      where("dateStr", "==", todayStr));
      const existing = await getDocs(q);
      if (!existing.empty) {
        status.innerText = "‚ö†Ô∏è Attendance already marked today!";
        return;
      }

      await addDoc(collection(db, "attendance"), {
        userId: currentUser.id,
        username: currentUser.username,
        branchName: b.name,
        branchId: currentUser.branchId,
        time: serverTimestamp(),
        dateStr: todayStr,
        location: { lat: latitude, lng: longitude, distance }
      });

      status.innerText = "‚úÖ Attendance Marked Successfully!";
    }, () => alert("‚ö†Ô∏è Location access denied."));
  };

  </script>
  <script src="nn.js"></script>
</body>
</html>
