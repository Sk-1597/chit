<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Attendance</title>
<link rel="stylesheet" href="style.css">
<style>
/* ===== MOBILE-FRIENDLY DESIGN ===== */
body {
  margin: 0;
  font-family: "Segoe UI", sans-serif;
  background: #f3f4f6;
  color: #222;
}
header.topbar {
  background: #b40000;
  color: #fff;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  position: sticky;
  top: 0;
}
.user-info img {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  padding: 4px;
}
.top-icons {
  display: flex;
  align-items: center;
  gap: 12px;
}
.icon-btn {
  width: 28px;
  height: 28px;
}
.signout-btn image{
  background: none;
  border: none;
}
main.content {
  padding: 14px;
}
.welcome-text {
  font-size: 18px;
  margin-bottom: 6px;
}
#userName {
  font-size: 22px;
  font-weight: bold;
  text-transform: capitalize;
  margin-bottom: 20px;
}
.card {
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  margin-bottom: 18px;
  padding: 16px;
}
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.card-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}
.check-bttn {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.btn {
  border: none;
  padding: 10px 14px;
  color: #fff;
  font-weight: bold;
  border-radius: 50px;
  cursor: pointer;
}
.checkin { background: #2e2eff; }
.checkout { background: #b40000; }
.brkin { background: #ff9f00; }
.brkout { background: #008f39; }

.card-body {
  margin-top: 14px;
}
.card-body p {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 6px 0;
  font-size: 16px;
}
.card-body p img {
  height: 20px;
  background: #f0f0f0;
  border-radius: 50%;
  padding: 5px;
  box-shadow: 0 0 4px rgba(0,0,0,0.15);
}
#branchSelect, #branchSelect1 {
  font-weight: 600;
  text-transform: uppercase;
}
.status-box {
  text-align: center;
  font-weight: 600;
  padding: 10px;
  margin-top: 8px;
}
.status-success { color: green; }
.status-error { color: red; }

/* loader */
#loader {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(255,255,255,0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 999;
  display: none;
}
.spinner {
  width: 40px;
  height: 40px;
  border: 5px solid #ccc;
  border-top: 5px solid #b40000;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
</head>
<body class="attendance-page">

<header class="topbar">
  <div class="user-info">
    <a href="./profile">
      <img src="./resources/icons/user.png" alt="User">
    </a>
  </div>
  <div class="top-icons">
    <a href="./history">
      <img src="./resources/icons/history.png" alt="Report" class="icon-btn">
    </a>
    <button id="signOutBtn" class="signout-btn">
      <img src="./resources/icons/logout.png" alt="Logout" class="icon-btn">
    </button>
  </div>
</header>

<main class="content">
  <p class="welcome-text">Welcome,</p>
  <h2 id="userName">Loading...</h2>

  <section class="card">
    <div class="card-header">
      <h3>Today Attendance</h3>
      <div class="check-bttn">
        <button id="markBtn" class="btn checkin">Check In</button>
        <button id="checkout" class="btn checkout">Check Out</button>
      </div>
    </div>
    <div class="card-body blue">
      <p class="branch"><img src="./resources/icons/location.png"><span id="branchSelect"></span></p>
      <p><img src="./resources/icons/checkin.png"><span id="inTime">--</span></p>
      <p><img src="./resources/icons/checkout.png"><span id="outTime">--</span></p>
    </div>
  </section>

  <section class="card brake">
    <div class="card-header">
      <h3>Break Time</h3>
      <div class="check-bttn">
        <button id="brkout" class="btn brkin">Out</button>
        <button id="brkin"  class="btn brkout">In</button>
      </div>
    </div>
    <div class="card-body red">
      <p class="branch"><img src="./resources/icons/location.png"><span id="branchSelect1"></span></p>
      <p><img src="./resources/icons/checkout.png"><span>--</span></p>
      <p><img src="./resources/icons/checkin.png"><span>--</span></p>
      <p><img src="./resources/icons/purpose.png"><span>--</span></p>
    </div>
  </section>

  <div id="status" class="status-box"></div>
</main>

<div id="loader"><div class="spinner"></div></div>

<script type="module">
import { db } from './firebase.js';
import { getDoc, doc, addDoc, updateDoc, collection, getDocs, query, where, serverTimestamp } 
  from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const loader = document.getElementById("loader");
const statusBox = document.getElementById("status");
const currentUser = JSON.parse(localStorage.getItem("loggedUser"));
if (!currentUser) window.location.href = "./";

userName.textContent = currentUser.user;

// --- Load branch ---
const branchRef = doc(db, "branches", currentUser.branchId);
const branchDoc = await getDoc(branchRef);
let branchData = null;
if (branchDoc.exists()) {
  branchData = branchDoc.data();
  branchSelect.textContent = branchData.name;
  branchSelect1.textContent = branchData.name;
}

// --- Load today's attendance record ---
const todayStr = new Date().toISOString().slice(0,10);
const q = query(
  collection(db, "attendance"),
  where("userId", "==", currentUser.id),
  where("dateStr", "==", todayStr)
);
const snap = await getDocs(q);

if (!snap.empty) {
  const docData = snap.docs[0].data();
  if (docData.time) {
    const d = docData.time.toDate();
    document.getElementById("inTime").textContent =
      `${d.toLocaleDateString('en-IN')} : ${d.toLocaleTimeString('en-IN')}`;
  }
  if (docData.checkoutTime) {
    const out = docData.checkoutTime.toDate();
    document.getElementById("outTime").textContent =
      `${out.toLocaleDateString('en-IN')} : ${out.toLocaleTimeString('en-IN')}`;
  }
}

// --- Distance calculator ---
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 +
            Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
            Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// --- CHECK-IN ---
markBtn.onclick = async () => {
  statusBox.textContent = "";
  loader.style.display = "flex";

  if (!branchData) return alert("Branch not found");

  navigator.geolocation.getCurrentPosition(async (pos) => {
    const { latitude, longitude } = pos.coords;
    const distance = getDistance(latitude, longitude, branchData.lat, branchData.lng);
    const radius = Number(branchData.radius_m);

    if (isNaN(branchData.lat) || isNaN(branchData.lng) || isNaN(radius)) {
      loader.style.display = "none";
      return alert("âš ï¸ Invalid branch location data");
    }

    if (currentUser.role !== "admin" && distance > radius) {
      loader.style.display = "none";
      statusBox.className = "status-box status-error";
      statusBox.textContent = `ðŸš« Outside branch area (${Math.round(distance)}m > ${radius}m)`;
      return;
    }

    const todayStr = new Date().toISOString().slice(0,10);
    const q = query(collection(db, "attendance"),
                    where("userId", "==", currentUser.id),
                    where("dateStr", "==", todayStr));
    const existing = await getDocs(q);
    if (!existing.empty) {
      loader.style.display = "none";
      statusBox.className = "status-box status-error";
      statusBox.textContent = "âš ï¸ Attendance already marked today!";
      return;
    }

    await addDoc(collection(db, "attendance"), {
      userId: currentUser.id,
      username: currentUser.username,
      branchName: branchData.name,
      branchId: currentUser.branchId,
      time: serverTimestamp(),
      dateStr: todayStr,
      location: { lat: latitude, lng: longitude, distance }
    });

    loader.style.display = "none";
    statusBox.className = "status-box status-success";
    statusBox.textContent = "âœ… Attendance Marked Successfully!";
  }, () => {
    loader.style.display = "none";
    alert("âš ï¸ Location access denied.");
  });
};

// --- CHECK-OUT ---
const checkoutBtn = document.getElementById("checkout");
checkoutBtn.addEventListener("click", async () => {
  const confirmOut = confirm("Do you really want to Check Out?");
  if (!confirmOut) return;

  loader.style.display = "flex";

  navigator.geolocation.getCurrentPosition(async (pos) => {
    const { latitude, longitude } = pos.coords;
    const distance = getDistance(latitude, longitude, branchData.lat, branchData.lng);
    const radius = Number(branchData.radius_m);

    if (distance > radius && currentUser.role !== "admin") {
      loader.style.display = "none";
      alert(`âš ï¸ You are outside branch area (${Math.round(distance)}m > ${radius}m)`);
      return;
    }

    const q = query(
      collection(db, "attendance"),
      where("userId", "==", currentUser.id),
      where("dateStr", "==", todayStr)
    );

    const snap = await getDocs(q);
    if (snap.empty) {
      loader.style.display = "none";
      return alert("âš ï¸ You haven't checked in yet!");
    }

    const attDoc = snap.docs[0];
    const attRef = attDoc.ref;

    if (attDoc.data().checkoutTime) {
      loader.style.display = "none";
      return alert("âœ… You already checked out!");
    }

    await updateDoc(attRef, {
      checkoutTime: serverTimestamp(),
      checkoutLocation: { lat: latitude, lng: longitude, distance }
    });

    const now = new Date();
    document.getElementById("outTime").textContent =
      `${now.toLocaleDateString('en-IN')} : ${now.toLocaleTimeString('en-IN')}`;
    loader.style.display = "none";
    alert("âœ… Checked out successfully!");
  }, () => {
    loader.style.display = "none";
    alert("âš ï¸ Location access denied.");
  });
});

// --- BREAK OUT / IN ---
const brkOut = document.getElementById("brkout");
const brkIn = document.getElementById("brkin");

brkOut.addEventListener("click", async () => {
  const confirmOut = confirm("Start break now?");
  if (!confirmOut) return;
  const q = query(
    collection(db, "attendance"),
    where("userId", "==", currentUser.id),
    where("dateStr", "==", todayStr)
  );
  const snap = await getDocs(q);
  if (snap.empty) return alert("âš ï¸ You haven't checked in yet!");

  const attDoc = snap.docs[0];
  const attRef = attDoc.ref;

  await updateDoc(attRef, { breakOut: serverTimestamp() });
  alert("ðŸµ Break started!");
});

brkIn.addEventListener("click", async () => {
  const confirmIn = confirm("End break now?");
  if (!confirmIn) return;
  const q = query(
    collection(db, "attendance"),
    where("userId", "==", currentUser.id),
    where("dateStr", "==", todayStr)
  );
  const snap = await getDocs(q);
  if (snap.empty) return alert("âš ï¸ You haven't checked in yet!");

  const attDoc = snap.docs[0];
  const attRef = attDoc.ref;

  await updateDoc(attRef, { breakIn: serverTimestamp() });
  alert("âœ… Break ended!");
});

// --- sign out
document.getElementById("signOutBtn").addEventListener("click", () => {
  localStorage.removeItem("loggedUser");
  window.location.href = "./";
});
</script>
</body>
</html>
